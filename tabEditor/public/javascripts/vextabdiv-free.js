/*

 VexFlow TabDiv 1.0-pre2
 Copyright 2010 Mohit Muthanna Cheppudira <mohit@muthanna.com>

 A library for embedding editable tablature into HTML5 pages, using
 the VexTab tablature language.

 - Requires jQuery and VexFlow for HTML5 Canvas rendering.
 - Requires Raphael.js for SVG and VML support.

 This library is distributed in the hope that it will be useful, but WITHOUT
 ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
 FITNESS FOR A PARTICULAR PURPOSE.

 This library must only be used in its original form. No tampering,
 modification, distribution, or repackaging is allowed without the
 explicit permission of the copyright holder.

 Build ID: prod-2@099117ff6457f700a7b2098c8eb5423aa5ce6229
 Build date: 2010-09-18 17:37:01.065220

*/
var a;Vex.Flow.VexTab=function(){this.init()};a=Vex.Flow.VexTab.prototype;a.init=function(){this.elements={staves:[],tabnotes:[],notes:[],ties:[],beams:[]};this.state={current_line:0,current_stave:-1,current_duration:"8",has_notation:false,beam_start:null};this.valid=false;this.last_error="";this.height=this.last_error_line=0;this.tuning=new Vex.Flow.Tuning};a.isValid=function(){return this.valid};a.getElements=function(){return this.elements};a.getHeight=function(){return this.height};
a.parse=function(b){this.init();b=b.split("\n");for(var d=0;d<b.length;++d){var e=b[d];this.state.current_line++;e=e.replace(/(^\s*)|(\s*$)/gi,"");e!=""&&this.parseLine(e)}this.valid=true;this.height+=30;return this};a.parseError=function(b){this.valid=false;this.last_error=b;this.last_error_line=this.state.current_line;b=new Vex.RERR("ParseError","Line "+this.state.current_line+": "+b);b.line=this.state.current_line;throw b;};
a.parseLine=function(b){b=b.split(/\s+/);var d=b[0];switch(d){case "tabstave":this.parseTabStave(b);break;case "notes":this.parseNotes(b);break;default:this.parseError("Invalid keyword: "+d)}};a.parseKeyValue=function(b){var d=b.split(/\s*=\s*/);d.length!=2&&this.parseError("Invalid key value pair: "+b);return{key:d[0],value:d[1]}};
a.parseTabStave=function(b){for(var d=false,e=1;e<b.length;++e){var h=this.parseKeyValue(b[e]);if(h.key.toLowerCase()=="notation")switch(h.value.toLowerCase()){case "true":d=true;break;case "false":d=false;break;default:this.parseError('notation must be "true" or "false": '+h.value)}else this.parseError("Invalid parameter for tabstave: "+h.key)}this.genTabStave({notation:d})};
a.parseNotes=function(b){for(var d=1;d<b.length;++d)switch(b[d]){case "|":this.genBar();break;case "[":this.parseOpenBeam();break;case "]":this.parseCloseBeam();break;default:this.parseToken(b[d]);this.genElements()}this.state.beam_start!=null&&this.parseError("Beam not closed")};
a.getNextRegExp=function(b){this.parse_state.done&&this.parseError("Unexpected end of line");if(b=this.parse_state.str.match(b)){this.parse_state.value=b[1];this.parse_state.str=b[2];if(this.parse_state.str=="")this.parse_state.done=true;return true}this.parseError("Error parsing notes at: "+this.parse_state.str);return false};a.getNextToken=function(){return this.getNextRegExp(/^(\d+|[\)\(-tbhpsvV\.\/\|\:])(.*)/)};a.getNextDurationToken=function(){return this.getNextRegExp(/^([0-9a-z]+|:)(.*)/)};
a.parseToken=function(b){this.parse_state={str:b,done:false,expecting_string:false,positions:[],durations:[],position_index:-1,annotations:[],bends:[],vibratos:[],ties:[],chord_ties:[],inside_bend:false,chord_index:-1};for(b=false;!b&&this.getNextToken();){switch(this.parse_state.value){case "(":this.parseOpenChord();break;case "t":this.parseTapAnnotation();break;default:this.parseFret()}b=this.parse_state.done}};
Vex.Flow.VexTab.validDurations={w:"w",h:"h",q:"q","8":"8","8d":"8d","16":"16","16d":"16d","32":"32","32d":"32d"};a=Vex.Flow.VexTab.prototype;
a.parseDuration=function(){this.getNextDurationToken();var b=Vex.Flow.VexTab.validDurations[this.parse_state.value];if(b)this.state.current_duration=b;else this.parseError("Invalid duration: "+this.parse_state.value);if(!this.parse_state.done){this.getNextDurationToken();this.parse_state.value!=":"&&this.parseError("Unexpected token: "+this.parse_state.str);this.parse_state.done||this.parseError("Unexpected token: "+this.parse_state.str)}};
a.parseOpenChord=function(){this.parse_state.positions.push([]);this.parse_state.durations.push(this.state.current_duration);this.parse_state.position_index++;this.parse_state.chord_index=-1;this.getNextToken();this.parseChordFret()};a.parseTapAnnotation=function(){this.parse_state.annotations.push({position:this.parse_state.position_index+1,text:"T"});this.getNextToken();switch(this.parse_state.value){case "(":this.parseOpenChord();break;default:this.parseFret()}};
a.parseChordFret=function(){if(this.parse_state.value==":"){this.parseFretDuration();this.parse_state.durations[this.parse_state.durations.length-1]=this.state.current_duration;if(this.parse_state.done)return;this.getNextToken()}var b=this.parse_state.value;isNaN(parseInt(b))&&this.parseError("Invalid fret number: "+b);this.getNextToken();if(this.parse_state.value=="b")this.parseChordBend();else this.parse_state.value!="/"&&this.parseError("Expecting / for string number: "+this.parse_state.value);
this.getNextToken();var d=parseInt(this.parse_state.value);isNaN(parseInt(d))&&this.parseError("Invalid string number: "+this.parse_state.value);this.parse_state.positions[this.parse_state.position_index].push({fret:b,str:d});this.parse_state.chord_index++;this.getNextToken();switch(this.parse_state.value){case ".":this.getNextToken();this.parseChordFret();break;case ")":this.parseCloseChord();break;default:this.parseError("Unexpected token: "+this.parse_state.value)}};
a.parseCloseChord=function(){this.chord_index=-1;if(!this.parse_state.done){this.getNextToken();switch(this.parse_state.value){case "h":this.parseChordTie();break;case "p":this.parseChordTie();break;case "s":this.parseChordTie();break;case "t":this.parseChordTie();break;case "v":this.parseVibrato();break;case "V":this.parseVibrato();break;default:this.parseError("Unexpected token: "+this.parse_state.value)}}};
a.parseChordBend=function(){this.getNextToken();var b=parseInt(this.parse_state.value);isNaN(b)&&this.parseError("Expecting fret: "+this.parse_state.value);if(this.parse_state.inside_bend)this.parse_state.bends[this.parse_state.bends.length-1].count++;else{this.parse_state.inside_bend=true;this.parse_state.bends.push({position:this.parse_state.position_index,count:1,index:this.parse_state.chord_index+1,to_fret:b})}this.getNextToken();switch(this.parse_state.value){case "b":this.parseChordBend();break;
case "/":break;default:this.parseError("Unexpected token: "+this.parse_state.value)}this.parse_state.inside_bend=false};a.parseFretDuration=function(){this.getNextDurationToken();var b=Vex.Flow.VexTab.validDurations[this.parse_state.value];if(b)this.state.current_duration=b;else this.parseError("Invalid duration: "+this.parse_state.value);if(!this.parse_state.done){this.getNextDurationToken();this.parse_state.value!=":"&&this.parseError("Unexpected token: "+this.parse_state.str)}};
a.parseFret=function(){if(this.parse_state.value==":"){this.parseFretDuration();if(this.parse_state.done)return;this.getNextToken()}var b=this.parse_state.value;isNaN(parseInt(b))&&this.parseError("Invalid fret number: "+b);this.parse_state.positions.push([{fret:b}]);this.parse_state.durations.push(this.state.current_duration);this.parse_state.position_index++;this.getNextToken();switch(this.parse_state.value){case "-":this.parseDash();break;case "/":this.parseSlash();break;case "b":this.parseBend();
break;case "s":this.parseTie();break;case "t":this.parseTie();break;case "h":this.parseTie();break;case "p":this.parseTie();break;case "v":this.parseFretVibrato();break;case "V":this.parseFretVibrato();break;default:this.parseError("Unexpected token: "+this.parse_state.value)}};a.parseDash=function(){this.parse_state.inside_bend=false;this.parse_state.expecting_string&&this.parseError("No dashes on strings: "+this.parse_state.str)};
a.parseVibrato=function(){var b=false;if(this.parse_state.value=="V")b=true;var d=this.parse_state.position_index;if(this.parse_state.inside_bend)d-=this.parse_state.bends[this.parse_state.bends.length-1].count;this.parse_state.vibratos.push({position:d,harsh:b})};
a.parseFretVibrato=function(){this.parseVibrato();this.getNextToken();switch(this.parse_state.value){case "-":this.parseDash();break;case "s":this.parseTie();break;case "h":this.parseTie();break;case "p":this.parseTie();break;case "t":this.parseTie();break;case "/":this.parseSlash();break;default:this.parseError("Unexpected token: "+this.parse_state.value)}};a.parseSlash=function(){this.parse_state.inside_bend=false;this.parse_state.expecting_string=true;this.getNextToken();this.parseString()};
a.parseString=function(){var b=this.parse_state.value;this.parse_state.positions.length==0&&this.parseError("String without frets: "+b);for(var d=0;d<this.parse_state.positions.length;++d)this.parse_state.positions[d][0].str=b};
a.parseTie=function(){this.parse_state.inside_bend=false;this.parse_state.expecting_string&&this.parseError("Unexpected token on string: "+this.parse_state.str);this.parse_state.ties.push({position:this.parse_state.position_index,index:this.parse_state.chord_index+1,effect:this.parse_state.value.toUpperCase()});this.getNextToken();this.parseFret()};
a.parseChordTie=function(){this.parse_state.chord_ties.push({position:this.parse_state.position_index,effect:this.parse_state.value.toUpperCase()});this.getNextToken();this.parse_state.value!="("&&this.parseError("Expecting ( after chord ties/slides");this.parseOpenChord()};
a.parseBend=function(){this.parse_state.expecting_string&&this.parseError("Unexpected token on string: "+this.parse_state.str);if(this.parse_state.inside_bend)this.parse_state.bends[this.parse_state.bends.length-1].count++;else{this.parse_state.inside_bend=true;this.parse_state.bends.push({position:this.parse_state.position_index,count:1,index:0})}this.getNextToken();this.parseFret()};
a.genElements=function(){function b(p){for(var o=p;o>=0;--o)if(h[o].persist==true)return o;throw new Vex.RERR("GenError","Invalid position: "+p);}this.state.current_stave==-1&&this.genTabStave();for(var d=this.parse_state.positions,e=this.parse_state.durations,h=[],i=[],f=0;f<d.length;++f){var c=d[f],j=e[f],g=new Vex.Flow.TabNote({positions:c,duration:j});h.push({note:g,persist:true});if(this.state.has_notation){var l=[],k=[];for(g=0;g<c.length;++g){var m=c[g];m=this.tuning.getNoteForFret(m.fret,
m.str);var n=Vex.Flow.keyProperties(m);k.push(n.accidental);l.push(m)}c=new Vex.Flow.StaveNote({keys:l,duration:j});for(g=0;g<k.length;++g)k[g]&&c.addAccidental(g,new Vex.Flow.Accidental(k[g]));i.push(c)}}g=this.parse_state.bends;for(f=0;f<g.length;++f){c=g[f];e=parseInt(d[c.position][c.index].fret);if(g[f].to_fret)j=g[f].to_fret;else{j=parseInt(d[c.position+1][c.index].fret);for(k=1;k<=c.count;++k)h[c.position+k].persist=false}k=false;if(c.count>1)k=true;l=h[c.position].note;switch(j-e){case 1:l.addModifier(new Vex.Flow.Bend("1/2",
k),c.index);break;case 2:l.addModifier(new Vex.Flow.Bend("Full",k),c.index);break;case 3:l.addModifier(new Vex.Flow.Bend("1 1/2",k),c.index);break;case 4:l.addModifier(new Vex.Flow.Bend("2 Steps",k),c.index);break;default:l.addModifier(new Vex.Flow.Bend("Bend to "+j,k),c.index)}}g=this.parse_state.vibratos;for(f=0;f<g.length;++f){c=g[f];h[c.position].note.addModifier((new Vex.Flow.Vibrato).setHarsh(c.harsh))}g=this.parse_state.annotations;for(f=0;f<g.length;++f){c=g[f];h[c.position].note.addModifier(new Vex.Flow.Annotation(c.text))}c=
this.parse_state.ties;for(f=0;f<c.length;++f){e=c[f];j=b(e.position);g=e.effect=="S"?new Vex.Flow.TabSlide({first_note:h[j].note,last_note:h[e.position+1].note}):new Vex.Flow.TabTie({first_note:h[j].note,last_note:h[e.position+1].note},e.effect);this.state.has_notation&&this.elements.ties[this.state.current_stave].push(new Vex.Flow.StaveTie({first_note:i[j],last_note:i[e.position+1]}));this.elements.ties[this.state.current_stave].push(g)}k=this.parse_state.chord_ties;for(f=0;f<k.length;++f){e=k[f];
j=b(e.position);l=[];for(g=0;g<d[j].length;++g){c=d[j][g];l[c.str]={from:g}}for(g=0;g<d[e.position+1].length;++g){c=d[e.position+1][g];l[c.str]||(l[c.str]={});l[c.str].to=g}c=[];m=[];for(g=0;g<l.length;++g)if(n=l[g])if(!(typeof n.from=="undefined"||typeof n.to=="undefined")){c.push(n.from);m.push(n.to)}g=e.effect=="S"?new Vex.Flow.TabSlide({first_note:h[j].note,last_note:h[e.position+1].note,first_indices:c,last_indices:m}):new Vex.Flow.TabTie({first_note:h[j].note,last_note:h[e.position+1].note,
first_indices:c,last_indices:m},e.effect);this.state.has_notation&&this.elements.ties[this.state.current_stave].push(new Vex.Flow.StaveTie({first_note:i[j],last_note:i[e.position+1],first_indices:c,last_indices:m}));this.elements.ties[this.state.current_stave].push(g)}for(f=0;f<h.length;++f){c=h[f];c.persist?this.elements.tabnotes[this.state.current_stave].push(c.note):this.elements.tabnotes[this.state.current_stave].push(new Vex.Flow.GhostNote(this.state.current_duration))}for(f=0;f<i.length;++f){c=
i[f];this.elements.notes[this.state.current_stave].push(c)}};
a.genTabStave=function(b){var d=false;if(b)d=b.notation;b=d?(new Vex.Flow.Stave(20,this.height,380)).addTrebleGlyph().setNoteStartX(40):null;var e=(new Vex.Flow.TabStave(20,d?b.getHeight()+this.height:this.height,380)).addTabGlyph().setNoteStartX(40);this.elements.staves.push({tab:e,note:b});this.height+=e.getHeight()+(d?b.getHeight():null);this.state.current_stave++;this.state.has_notation=d;this.elements.tabnotes[this.state.current_stave]=[];this.elements.notes[this.state.current_stave]=[];this.elements.ties[this.state.current_stave]=
[]};a.parseOpenBeam=function(){this.state.beam_start!=null&&this.parseError("Beam already open: [");this.state.beam_start=this.elements.notes[this.state.current_stave].length};
a.parseCloseBeam=function(){this.state.beam_start==null&&this.parseError("Can't close beam without openeing: ]");var b=this.elements.notes[this.state.current_stave].length;b-this.state.beam_start<2&&this.parseError("Must have at least two notes in a beam.");for(var d=[],e=this.state.beam_start;e<b;++e)d.push(this.elements.notes[this.state.current_stave][e]);this.elements.beams.push(new Vex.Flow.Beam(d));this.state.beam_start=null};
a.genBar=function(){this.state.current_stave==-1&&this.genTabStave();this.elements.tabnotes[this.state.current_stave].push(new Vex.Flow.BarNote);this.elements.notes[this.state.current_stave].push(new Vex.Flow.BarNote)};Vex.Flow.TabDiv=function(){this.scale=this.height=this.width=this.code="";this.renderer=this.canvas=null};Vex.Flow.TabDiv.SEL=".vex-tabdiv";Vex.Flow.TabDiv.ERROR_NOCANVAS="<b>This browser does not support HTML5 Canvas</b><br/>Please use a modern browser such as <a href='http://google.com/chrome'>Google Chrome</a> or <a href='http://firefox.com'>Firefox</a>.";a=Vex.Flow.TabDiv.prototype;a.redraw=function(){var b=this;Vex.BM("Total render time: ",function(){b.parse();b.draw()});return this};
a.resize=function(){this.renderer.resize(this.width*this.scale,this.height*this.scale);this.ctx=this.renderer.getContext()};
a.drawInternal=function(){if(!this.parser.isValid())return this;this.editor_error&&this.editor_error.empty();var b=this.parser.getElements(),d=b.staves;if(d.length==0){this.resize(this.width,10);this.ctx.clear();return this}var e=b.tabnotes,h=b.notes,i=b.ties;b=b.beams;this.height=this.parser.getHeight()+this.extra_height;this.resize(this.width,this.height);this.ctx.clear();this.ctx.setFont("Arial",8,"Bold");for(var f=0;f<d.length;++f){var c=d[f].tab,j=d[f].note,g=e[f],l=i[f];c.setWidth(this.width-
50);c.setContext(this.ctx).draw();if(j){var k=h[f];j.setWidth(this.width-50);j.setContext(this.ctx).draw();g&&k&&Vex.Flow.Formatter.FormatAndDrawTab(this.ctx,c,j,g,k,this.width-100)}else g&&Vex.Flow.Formatter.FormatAndDraw(this.ctx,c,g,this.width-100);for(c=0;c<l.length;++c)l[c].setContext(this.ctx).draw()}for(c=0;c<b.length;++c)b[c].setContext(this.ctx).draw();if(this.message){this.ctx.setFont("Times",10,"bold italic");this.ctx.fillText(this.message,this.width/2-40,this.height-10)}return this};
a.parseInternal=function(){try{this.parser.parse(this.code)}catch(b){if(this.editor_error){this.editor_error.empty();this.editor_error.append($("<span></span>").addClass("text").html(b.message))}}return this};a.parse=function(){var b=this;Vex.BM("Parse time: ",function(){b.parseInternal()});return this};a.draw=function(){var b=this;Vex.BM("Draw time: ",function(){b.drawInternal()});return this};(function(b){var d={init:function(e){return this.each(function(){var h=b(this),i={editor:null,prepend_errors:true,width:400,height:200,scale:1};e&&b.extend(i,e);var f=!!i.editor&&b(i.editor).length>0&&b(i.editor)[0].tagName=="TEXTAREA",c=f?b(i.editor):null;vextab=new Vex.Flow.TabDiv;vextab.code=h.text();h.empty();vextab.width=i.width;vextab.height=i.height;vextab.scale=i.scale;if(typeof Raphael=="undefined"){vextab.canvas=b("<canvas></canvas>").addClass("vex-canvas");h.append(vextab.canvas);vextab.renderer=
new Vex.Flow.Renderer(vextab.canvas[0],Vex.Flow.Renderer.Backends.CANVAS)}else{vextab.canvas=b("<div></div>").addClass("vex-canvas");h.append(vextab.canvas);vextab.renderer=new Vex.Flow.Renderer(vextab.canvas[0],Vex.Flow.Renderer.Backends.RAPHAEL)}vextab.renderer.resize(i.width,i.height);vextab.ctx=vextab.renderer.getContext();vextab.ctx.scale(i.scale,i.scale);if(f){c.addClass("editor").val(vextab.code);vextab.editor_error=b("<div class='editor-error'></div>");i.prepend_errors?c.before(vextab.editor_error):
c.after(vextab.editor_error);c.keyup(function(){vextab.timeoutID&&window.clearTimeout(vextab.timeoutID);vextab.timeoutID=window.setTimeout(function(){if(vextab.code!=c.val()){vextab.code=c.val();vextab.redraw()}},100)})}h.data("initialized",true);vextab.parser=new Vex.Flow.VexTab;vextab.message="vexflow.com";vextab.extra_height=vextab.message?20:10;vextab.redraw();h.data("tabmachine",vextab)})},renderText:function(e){return this.each(function(){var h=b(this);if(h.data("initialized")){vextab=h.data("tabmachine");
vextab.code=e;vextab.redraw()}else{h.text(e);h.tabdiv()}})},code:function(){if(this.data("initialized"))return this.data("tabmachine").code}};b.fn.tabdiv=function(e){if(d[e])return d[e].apply(this,Array.prototype.slice.call(arguments,1));else if(typeof e==="object"||!e)return d.init.apply(this,arguments);else{b.error("Method "+e+" does not exist on jQuery.tabdiv");return false}}})(jQuery);
